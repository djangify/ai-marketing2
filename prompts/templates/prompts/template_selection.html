<!-- prompts/templates/prompts/template_selection.html -->
<div class="fixed inset-0 bg-slate-500 bg-opacity-60 z-50 flex items-center justify-center" id="template-selection-modal">
    <div class="bg-white rounded-xl p-6 shadow-lg w-full max-w-lg mx-4">
        <div class="flex flex-col space-y-4">
            <h3 class="text-lg font-bold">Import Content</h3>
            <p class="text-sm text-gray-600">Choose content to import into your project</p>
            
            <!-- Tabs Navigation -->
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button id="tab-templates" class="tab-nav-btn border-[#9810fa] text-[#9810fa] border-b-2 py-2 px-1 text-sm font-medium" data-target="content-templates">
                        Templates
                    </button>
                    <button id="tab-prompts" class="tab-nav-btn border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 py-2 px-1 text-sm font-medium" data-target="content-prompts">
                        My Generated Prompts
                    </button>
                </nav>
            </div>
            
            <!-- Tab Content: Templates -->
            <div id="content-templates" class="tab-panel">
                <div class="flex justify-center items-center py-2">
                    {% if templates %}
                        <select id="template-select" class="w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-[#9810fa] focus:border-[#9810fa]">
                            <option value="" disabled selected>Select a Template</option>
                            {% for template in templates %}
                                <option value="{{ template.id }}" data-type="template">{{ template.title }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <div class="text-center w-full">
                            <p class="mb-4">You do not have any templates with existing prompts.</p>
                            <a href="{% url 'content_templates:template_list' %}" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-[#9810fa] text-white shadow hover:bg-[#9810fa]/90 h-9 px-4 py-2">
                                Create Template
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Tab Content: Generated Prompts -->
            <div id="content-prompts" class="tab-panel hidden">
                <div class="flex justify-center items-center py-2">
                    {% if generated_prompts %}
                        <select id="prompt-select" class="w-full bg-white border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-[#9810fa] focus:border-[#9810fa]">
                            <option value="" disabled selected>Select a Generated Prompt</option>
                            {% for prompt in generated_prompts %}
                                <option value="{{ prompt.id }}" data-type="generated_prompt">{{ prompt.name }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <div class="text-center w-full">
                            <p class="mb-4">You do not have any generated prompts.</p>
                            <a href="{% url 'prompt_generator:generator' %}" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-[#9810fa] text-white shadow hover:bg-[#9810fa]/90 h-9 px-4 py-2">
                                Generate Prompts
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- CSRF Token for Ajax requests -->
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            
            <div class="flex justify-end space-x-2 mt-4">
                <button class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2" onclick="closeTemplateModal()">
                    Cancel
                </button>
                <button id="confirm-import-button" class="btn-main inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-[#9810fa] text-white shadow-sm hover:bg-[#9810fa]/90 h-9 px-4 py-2" onclick="importContent()">
                    Import
                </button>
            </div>
        </div>
    </div>
</div>
 
<script>
    // Execute immediately when loaded
    (function() {
      console.log("Modal tab script loaded");
      
      // Get tab elements
      const templatesTab = document.getElementById('tab-templates');
      const promptsTab = document.getElementById('tab-prompts');
      
      if (templatesTab && promptsTab) {
        console.log("Found tab elements, attaching event listeners");
        
        // Templates tab click handler
        templatesTab.onclick = function(e) {
          e.preventDefault();
          console.log("Templates tab clicked");
          
          // Show templates, hide prompts
          document.getElementById('content-templates').style.display = 'block';
          document.getElementById('content-prompts').style.display = 'none';
          
          // Update active styles
          templatesTab.className = 'tab-button border-[#9810fa] text-[#9810fa] border-b-2 py-2 px-1 text-sm font-medium';
          promptsTab.className = 'tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 py-2 px-1 text-sm font-medium';
        };
        
        // Prompts tab click handler
        promptsTab.onclick = function(e) {
          e.preventDefault();
          console.log("Prompts tab clicked");
          
          // Show prompts, hide templates
          document.getElementById('content-templates').style.display = 'none';
          document.getElementById('content-prompts').style.display = 'block';
          
          // Update active styles
          promptsTab.className = 'tab-button border-[#9810fa] text-[#9810fa] border-b-2 py-2 px-1 text-sm font-medium';
          templatesTab.className = 'tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 py-2 px-1 text-sm font-medium';
        };
        
        // Fix for the import button
        const importButton = document.getElementById('confirm-import-button');
        if (importButton) {
          importButton.onclick = function() {
            // Determine active tab
            const isPromptTab = promptsTab.className.includes('border-[#9810fa]');
            let selectedId, endpoint, payload;
            
            if (isPromptTab) {
              // Get selected prompt
              const promptSelect = document.getElementById('prompt-select');
              if (!promptSelect || !promptSelect.value) {
                alert("Please select a generated prompt");
                return;
              }
              selectedId = promptSelect.value;
              endpoint = '/prompts/{{ project.id }}/import-generated-prompt/';
              payload = { promptId: selectedId };
            } else {
              // Get selected template
              const templateSelect = document.getElementById('template-select');
              if (!templateSelect || !templateSelect.value) {
                alert("Please select a template");
                return;
              }
              selectedId = templateSelect.value;
              endpoint = '/prompts/{{ project.id }}/import-template/';
              payload = { templateId: selectedId };
            }
            
            // Show loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<svg class="animate-spin h-4 w-4 mr-2 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Importing...';
            this.disabled = true;
            
            // Get CSRF token
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            // Send request
            fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: JSON.stringify(payload)
            })
            .then(response => {
              console.log("Response status:", response.status);
              return response.json().then(data => {
                if (!response.ok) {
                  throw { 
                    message: data.message || "Unknown error", 
                    status: response.status
                  };
                }
                return data;
              });
            })
            .then(data => {
              console.log("Import successful:", data);
              window.location.href = '/projects/{{ project.id }}/?tab=prompts';
            })
            .catch(error => {
              console.error("Import error:", error);
              alert(error.message || "Error importing content");
              
              // Reset button
              this.innerHTML = originalText;
              this.disabled = false;
            });
          };
        } else {
          console.error("Import button not found");
        }
      } else {
        console.error("Tab elements not found");
      }
    })();
  </script>